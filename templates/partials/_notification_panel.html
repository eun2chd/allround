<style>
  /* 알림 패널 - 오른쪽에서 왼쪽으로 펼쳐짐 */
  .notification-panel {
    position: fixed;
    right: 0;
    top: 68px;
    width: 340px;
    max-width: calc(100vw - 24px);
    height: calc(100vh - 68px);
    background: var(--bg-white);
    border-left: 1px solid var(--border-gray);
    box-shadow: -4px 0 20px rgba(0,0,0,0.08);
    z-index: 95;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }
  .notification-panel.open {
    transform: translateX(0);
  }
  .notification-panel .panel-header {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 24px 40px 24px 20px;
    border-bottom: 1px solid var(--border-gray);
    flex-shrink: 0;
    background: var(--bg-white);
  }
  .notification-panel .panel-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 12px;
  }
  .notification-panel .panel-stats {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-dark);
  }
  .notification-panel .panel-stats span {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .notification-panel .panel-stats .count {
    font-weight: 700;
    color: var(--main-purple);
  }
  .notification-panel .panel-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .notification-panel .panel-action-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-gray);
    background: var(--bg-white);
    color: var(--text-dark);
    cursor: pointer;
    font-size: 0.8rem;
    border-radius: 6px;
    font-weight: 500;
  }
  .notification-panel .panel-action-btn:hover {
    background: var(--soft-purple);
    border-color: var(--main-purple);
    color: var(--main-purple);
  }
  .notification-panel .panel-action-btn.delete-all:hover {
    background: rgba(220, 38, 38, 0.1);
    border-color: #dc2626;
    color: #dc2626;
  }
  .notification-panel .panel-close {
    position: absolute;
    top: 20px;
    right: 16px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: var(--gray-muted);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .notification-panel .panel-close:hover {
    color: var(--main-purple);
  }
  .notification-panel .panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }
  .notification-panel .notification-item {
    display: flex;
    gap: 12px;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border-gray);
    cursor: pointer;
    transition: background 0.2s;
    align-items: flex-start;
    position: relative;
  }
  .notification-panel .noti-delete-btn {
    flex-shrink: 0;
    padding: 4px 8px;
    border: 1px solid #dc2626;
    background: transparent;
    color: #dc2626;
    cursor: pointer;
    font-size: 0.9rem;
    line-height: 1;
    border-radius: 4px;
  }
  .notification-panel .noti-delete-btn:hover {
    background: rgba(220, 38, 38, 0.1);
  }
  .notification-panel .noti-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
    align-items: center;
  }
  .notification-panel .noti-read-btn {
    padding: 4px 10px;
    border: 1px solid var(--main-purple);
    background: transparent;
    color: var(--main-purple);
    cursor: pointer;
    font-size: 0.72rem;
    border-radius: 4px;
    font-weight: 500;
  }
  .notification-panel .noti-read-btn:hover {
    background: var(--soft-purple);
  }
  .notification-panel .noti-read-btn:disabled {
    opacity: 0.5;
    cursor: default;
  }
  .notification-panel .notification-item:hover {
    background: var(--soft-purple);
  }
  .notification-panel .notification-item.unread {
    background: #f0f9ff;
  }
  .notification-panel .notification-item .noti-icon {
    width: 36px;
    height: 36px;
    min-width: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .notification-panel .notification-item .noti-icon img {
    width: 24px;
    height: 24px;
    object-fit: contain;
  }
  .notification-panel .notification-item .noti-content {
    flex: 1;
    min-width: 0;
  }
  .notification-panel .notification-item .noti-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-dark);
    margin-bottom: 4px;
  }
  .notification-panel .notification-item .noti-desc {
    font-size: 0.8rem;
    color: var(--gray-muted);
    line-height: 1.4;
  }
  .notification-panel .notification-item .noti-time {
    font-size: 0.72rem;
    color: var(--gray-muted);
    margin-top: 4px;
  }
  .notification-panel .empty-state {
    padding: 48px 24px;
    text-align: center;
    color: var(--gray-muted);
    font-size: 0.9rem;
  }
  @media (max-width: 1100px) {
    .notification-panel { display: none; }
  }
</style>

<aside class="notification-panel" id="notificationPanel">
  <div class="panel-header">
    <button type="button" class="panel-close" id="notificationPanelClose" title="닫기" aria-label="닫기">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
    <div class="panel-title">알림목록</div>
    <div class="panel-stats">
      <span>읽음 <span class="count" id="notiReadCount">0</span>건</span>
      <span>안읽음 <span class="count" id="notiUnreadCount">0</span>건</span>
      <span>총 <span class="count" id="notiTotalCount">0</span>건</span>
    </div>
    <div class="panel-actions">
      <button type="button" class="panel-action-btn" id="notiReadAllBtn" title="전체 읽음 처리">전체읽음</button>
      <button type="button" class="panel-action-btn delete-all" id="notiDeleteAllBtn" title="전체 삭제">전체 삭제</button>
    </div>
  </div>
  <div class="panel-body" id="notificationList">
    <div class="empty-state">새 알림이 없습니다.</div>
  </div>
</aside>

<script>
(function() {
  var NOTI_ICON_INSERT = "{{ url_for('static', filename='images/upload.png') }}";
  var NOTI_ICON_UPDATE = "{{ url_for('static', filename='images/update.png') }}";
  var NOTI_ICON_STATUS = "{{ url_for('static', filename='images/reload.png') }}";
  const panel = document.getElementById('notificationPanel');
  const closeBtn = document.getElementById('notificationPanelClose');
  const listEl = document.getElementById('notificationList');
  const readCountEl = document.getElementById('notiReadCount');
  const unreadCountEl = document.getElementById('notiUnreadCount');
  const totalCountEl = document.getElementById('notiTotalCount');
  const navDot = document.getElementById('navNotificationDot');

  if (!panel) return;

  function togglePanel() { panel.classList.toggle('open'); }
  function closePanel() { panel.classList.remove('open'); }

  document.querySelectorAll('.nav-btn-icon[title="알림"], #navNotificationBtn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      togglePanel();
      if (panel.classList.contains('open')) loadNotifications();
    });
  });
  if (closeBtn) closeBtn.addEventListener('click', closePanel);

  function showNotiToast(msg) {
    var t = document.getElementById('toast');
    if (t) { t.textContent = msg; t.className = 'toast success'; t.style.display = 'block'; setTimeout(function() { t.style.display = 'none'; }, 2000); }
  }
  var readAllBtn = document.getElementById('notiReadAllBtn');
  if (readAllBtn) {
    readAllBtn.addEventListener('click', function() {
      fetch('/api/notifications/read-all', { method: 'POST' }).then(function(r) { return r.json(); }).then(function(j) {
        if (j.success) { showNotiToast('전체 읽음 처리하였습니다'); loadNotifications(); }
      });
    });
  }
  var deleteAllBtn = document.getElementById('notiDeleteAllBtn');
  if (deleteAllBtn) {
    deleteAllBtn.addEventListener('click', function() {
      if (!confirm('모든 알림을 삭제하시겠습니까?')) return;
      fetch('/api/notifications/delete-all', { method: 'POST' }).then(function(r) { return r.json(); }).then(function(j) {
        if (j.success) { showNotiToast('전체 삭제하였습니다'); loadNotifications(); }
      });
    });
  }

  document.addEventListener('click', function(e) {
    if (panel.classList.contains('open') && !panel.contains(e.target) && !e.target.closest('.nav-btn-icon') && !e.target.closest('#navNotificationBtn')) {
      closePanel();
    }
  });

  function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, function(c) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]; }); }
  function formatTimeAgo(isoStr) {
    if (!isoStr) return '';
    var d = new Date(isoStr.replace('Z', '+00:00'));
    var now = new Date();
    var diff = Math.floor((now - d) / 1000);
    if (diff < 60) return '방금 전';
    if (diff < 3600) return Math.floor(diff / 60) + '분 전';
    if (diff < 86400) return Math.floor(diff / 3600) + '시간 전';
    if (diff < 2592000) return Math.floor(diff / 86400) + '일 전';
    return d.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
  }

  function updateNavDot(unread) {
    if (navDot) navDot.style.display = unread > 0 ? 'block' : 'none';
  }

  function renderNotifications(items, unreadCount) {
    if (!items || items.length === 0) {
      listEl.innerHTML = '<div class="empty-state">새 알림이 없습니다.</div>';
      if (readCountEl) readCountEl.textContent = '0';
      if (unreadCountEl) unreadCountEl.textContent = '0';
      if (totalCountEl) totalCountEl.textContent = '0';
      updateNavDot(0);
      return;
    }
    var readCount = items.filter(function(i) { return i.read; }).length;
    if (readCountEl) readCountEl.textContent = String(readCount);
    if (unreadCountEl) unreadCountEl.textContent = String(unreadCount);
    if (totalCountEl) totalCountEl.textContent = String(items.length);
    updateNavDot(unreadCount);
    listEl.innerHTML = items.map(function(n) {
      var cls = n.read ? '' : ' unread';
      var iconSrc = n.type === 'insert' ? NOTI_ICON_INSERT : (n.type === 'status' ? NOTI_ICON_STATUS : NOTI_ICON_UPDATE);
      var timeStr = formatTimeAgo(n.created_at);
      var readDisabled = n.read ? ' disabled' : '';
      var readBtn = '<button type="button" class="noti-read-btn" data-id="' + escapeHtml(n.id) + '" title="읽음"' + readDisabled + '>읽음</button>';
      var deleteBtn = '<button type="button" class="noti-delete-btn" data-id="' + escapeHtml(n.id) + '" title="삭제">삭제</button>';
      var actions = '<div class="noti-actions">' + readBtn + deleteBtn + '</div>';
      return '<div class="notification-item' + cls + '" data-id="' + escapeHtml(n.id) + '">' +
        '<div class="noti-icon"><img src="' + escapeHtml(iconSrc) + '" alt=""></div>' +
        '<div class="noti-content">' +
          '<div class="noti-title">' + escapeHtml(n.message || '알림') + '</div>' +
          (timeStr ? '<div class="noti-time">' + escapeHtml(timeStr) + '</div>' : '') +
        '</div>' + actions + '</div>';
    }).join('');
    listEl.querySelectorAll('.noti-read-btn').forEach(function(btn) {
      btn.addEventListener('click', function(ev) {
        ev.stopPropagation();
        var id = btn.dataset.id;
        if (!id || btn.disabled) return;
        fetch('/api/notifications/' + encodeURIComponent(id) + '/read', { method: 'POST' }).then(function(r) { return r.json(); }).then(function(j) {
          if (j.success) { showNotiToast('알림을 읽음 처리하였습니다'); loadNotifications(); }
        });
      });
    });
    listEl.querySelectorAll('.noti-delete-btn').forEach(function(btn) {
      btn.addEventListener('click', function(ev) {
        ev.stopPropagation();
        var id = btn.dataset.id;
        if (!id) return;
        fetch('/api/notifications/' + encodeURIComponent(id) + '/delete', { method: 'POST' }).then(function(r) { return r.json(); }).then(function(j) {
          if (j.success) { showNotiToast('알림을 삭제하였습니다'); loadNotifications(); }
        });
      });
    });
  }

  var lastUnreadCount = null;
  function loadNotifications() {
    fetch('/api/notifications').then(function(r) { return r.json(); }).then(function(j) {
      var unread = (j.success ? (j.unread_count || 0) : 0);
      if (j.success) {
        if (lastUnreadCount !== null && unread > lastUnreadCount) {
          var t = document.getElementById('toast');
          if (t) { t.textContent = '새 알림이 도착했습니다'; t.className = 'toast success'; t.style.display = 'block'; setTimeout(function() { t.style.display = 'none'; }, 2500); }
        }
        lastUnreadCount = unread;
        renderNotifications(j.data || [], unread);
      } else {
        renderNotifications([], 0);
      }
    }).catch(function() { renderNotifications([], 0); });
  }

  loadNotifications();
  setInterval(loadNotifications, 60000);
})();
</script>
