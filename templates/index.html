<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
  <title>Ntpercent 공모전</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css') }}">
  <style>
    @font-face {
      font-family: 'Pretendard Variable';
      src: url("{{ url_for('static', filename='font/PretendardVariable.ttf') }}") format('truetype');
      font-weight: 100 900;
      font-style: normal;
    }
    :root {
      --main-purple: #6d28d9;
      --main-purple-hover: #5b21b6;
      --soft-purple: #ede9fe;
      --text-dark: #212121;
      --gray-muted: #9ca3af;
      --accent-yellow: #f59e0b;
      --bg-white: #ffffff;
      --border-gray: #9ca3af;
      --radius: 8px;
      --font: 'Pretendard Variable', 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg-white);
      color: var(--text-dark);
      font-weight: 500;
      min-height: 100vh;
      line-height: 1.5;
    }
    .page-placeholder { padding: 80px 24px; text-align: center; font-size: 0.95rem; color: var(--gray-muted); }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px 48px; }
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-gray);
    }
    .page-header h1 { font-size: 1.05rem; font-weight: 700; color: var(--text-dark); }
    .page-header h1 span { color: var(--main-purple); }
    .page-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .page-meta-info {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .page-meta-info .refresh-hint { font-weight: 700; color: var(--text-dark); }
    .page-meta-info .countdown { color: var(--main-purple); font-weight: 700; }
    .page-meta-info .datetime { color: var(--text-dark); font-weight: 700; }
    .btn {
      font-family: var(--font);
      font-size: 0.82rem;
      font-weight: 500;
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    .btn-primary {
      background: var(--main-purple);
      color: #fff;
    }
    .btn-primary:hover {
      background: var(--main-purple-hover);
      transform: translateY(-1px);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .card {
      background: var(--bg-white);
      overflow: hidden;
    }
    .table-wrap {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    th {
      text-align: center;
      padding: 10px 12px;
      font-weight: 700;
      color: var(--text-dark);
      background: var(--soft-purple);
      border: 1px solid var(--border-gray);
      white-space: nowrap;
    }
    td {
      text-align: center;
      padding: 10px 12px;
      border: 1px solid var(--border-gray);
      vertical-align: middle;
    }
    tr:hover td { background: #faf5ff; }
    tr.row-new { border-left: 3px solid var(--accent-yellow); background: #fffbeb; }
    tr.row-viewed td { color: var(--text-dark); }
    tr.row-viewed .title-cell a { color: var(--text-dark); }
    .status-dot { display: inline-block; width: 8px; height: 8px; background: var(--accent-yellow); border-radius: 50%; margin-right: 8px; vertical-align: middle; }
    .status-check { color: #059669; margin-right: 8px; font-weight: bold; }
    .bookmark-star {
      cursor: pointer;
      font-size: 1.1rem;
      user-select: none;
      color: var(--border-gray);
      transition: color 0.2s;
    }
    .bookmark-star:hover { color: var(--accent-yellow); }
    .bookmark-star.bookmarked { color: var(--accent-yellow); }
    .title-cell {
      max-width: 280px;
      text-align: center;
      overflow: hidden;
    }
    .title-cell a {
      color: var(--text-dark);
      text-decoration: none;
      font-weight: 500;
      display: block;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .title-cell a:hover {
      color: var(--main-purple);
      text-decoration: underline;
    }
    .host-cell {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .cell-tooltip {
      position: relative;
      cursor: default;
    }
    .cell-tooltip[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 10px);
      transform: translateX(-50%);
      padding: 12px 16px;
      background: rgba(33, 33, 33, 0.95);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 500;
      line-height: 1.5;
      white-space: normal;
      max-width: 340px;
      min-width: 120px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 2000;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
      word-break: keep-all;
      overflow-wrap: break-word;
    }
    .cell-tooltip[data-tooltip]:hover::after {
      opacity: 1;
      visibility: visible;
    }
    .cell-tooltip[data-tooltip]::before {
      content: '';
      position: absolute;
      left: 50%;
      bottom: calc(100% + 2px);
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(33, 33, 33, 0.95);
      z-index: 2001;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .cell-tooltip[data-tooltip]:hover::before {
      opacity: 1;
      visibility: visible;
    }
    .d-day {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.74rem;
      font-weight: 500;
      white-space: nowrap;
    }
    td:nth-child(2),
    td:nth-child(5),
    td:nth-child(6),
    td:nth-child(7),
    td:nth-child(8) {
      white-space: nowrap;
    }
    .d-day.urgent { background: #dc2626; color: #fff; }
    .d-day.normal { background: var(--soft-purple); color: var(--main-purple); }
    .d-day.today { background: var(--accent-yellow); color: #fff; }
    .empty-state {
      padding: 60px 24px;
      text-align: center;
      color: var(--gray-muted);
    }
    .empty-state p { margin-bottom: 12px; font-size: 0.9rem; }
    .loading {
      padding: 40px;
      text-align: center;
      color: var(--gray-muted);
    }
    .loading::after {
      content: '';
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid var(--border-gray);
      border-top-color: var(--main-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .new-badge {
      display: inline-block;
      background: var(--accent-yellow);
      color: #fff;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
      font-weight: 500;
    }
    .toast {
      position: fixed;
      top: 80px;
      right: 24px;
      padding: 12px 20px;
      background: var(--bg-white);
      border: 1px solid var(--border-gray);
      border-radius: var(--radius);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      font-size: 0.9rem;
      z-index: 1000;
      animation: slideUp 0.3s ease;
    }
    .toast.success { border-left: 4px solid var(--main-purple); }
    .toast.error { border-left: 4px solid #da3633; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 20px;
      border-top: 1px solid var(--border-gray);
      flex-wrap: wrap;
    }
    .pagination-numbers {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .pagination button {
      font-family: var(--font);
      padding: 0;
      min-width: 36px;
      min-height: 36px;
      border: none;
      border-radius: 50%;
      background: var(--bg-white);
      color: var(--text-dark);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pagination button:hover:not(:disabled) {
      background: var(--soft-purple);
    }
    .pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .pagination-arrow img {
      width: 18px;
      height: 18px;
      display: block;
    }
    .pagination button.active {
      background: var(--main-purple);
      color: #fff;
    }
    .detail-row td {
      padding: 0;
      vertical-align: top;
      border-left: 1px solid var(--border-gray);
      border-right: 1px solid var(--border-gray);
      border-bottom: 1px solid var(--border-gray);
      background: var(--soft-purple);
    }
    .detail-row .detail-inner {
      padding: 16px 20px;
      max-height: 320px;
      overflow-y: auto;
      font-size: 0.9rem;
      white-space: pre-wrap;
      line-height: 1.6;
      text-align: left;
    }
    .detail-row .detail-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border-gray);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-shrink: 0;
    }
    .detail-loading { color: var(--gray-muted); text-align: center; padding: 30px; }
    .detail-meta { font-size: 0.85rem; color: var(--gray-muted); margin-bottom: 12px; }
    .detail-images { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; }
    .detail-images img { max-width: 280px; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border-gray); cursor: pointer; transition: opacity 0.2s; }
    .detail-images img:hover { opacity: 0.9; }
    .img-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 3000; padding: 24px; cursor: pointer; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
    .img-modal.open { opacity: 1; visibility: visible; }
    .img-modal img { max-width: 95%; max-height: 95vh; object-fit: contain; border-radius: 8px; }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--soft-purple);
      border-radius: var(--radius);
      border: 1px solid rgba(109, 40, 217, 0.2);
    }
    .filter-bar input,
    .filter-bar select {
      font-family: var(--font);
      font-size: 0.88rem;
      padding: 8px 12px;
      border: 1px solid var(--border-gray);
      border-radius: var(--radius);
      background: var(--bg-white);
      color: var(--text-dark);
    }
    .filter-bar input { flex: 1; min-width: 120px; }
    .filter-bar input::placeholder { color: var(--gray-muted); }
    .filter-bar input:focus,
    .filter-bar select:focus {
      outline: none;
      border-color: var(--main-purple);
      box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.15);
    }
    .filter-bar label {
      font-size: 0.8rem;
      color: var(--gray-muted);
      margin-right: 4px;
    }
    .filter-bar .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .filter-bar .filter-group select { min-width: 100px; }
    @media (max-width: 768px) {
      .container { padding: 24px 20px; }
    }
  </style>
</head>
<body>
  {% include 'partials/_navbar.html' %}

  <div class="container">
    <div id="pageAllyoung">
    <header class="page-header">
      <h1><span>{{ session.get('nickname', '') or '회원' }}</span>님, <span>요즘것들</span> 공고 모음을 확인해보세요</h1>
      <div class="page-meta">
        <div class="page-meta-info">
  
          <span class="countdown" id="countdown">(다음 갱신까지 30:00)</span>
          <span class="datetime" id="currentDateTime">-</span>
        </div>
      </div>
    </header>

    <div class="filter-bar" id="filterBar" style="display:none">
      <input type="text" id="searchInput" placeholder="제목, 주최·주관 검색" autocomplete="off">
      <div class="filter-group">
        <label for="categorySelect">카테고리</label>
        <select id="categorySelect">
          <option value="">전체</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="sourceSelect">출처</label>
        <select id="sourceSelect">
          <option value="">전체</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:40px" title="북마크">★</th>
              <th style="width:60px">No</th>
              <th style="width:60px">D-day</th>
              <th>제목</th>
              <th style="width:180px">주최/주관</th>
              <th style="width:100px">카테고리</th>
              <th style="width:80px">출처</th>
              <th style="width:140px">가져온 시간</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="8" class="loading">로딩 중</td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pagination" style="display:none">
        <button type="button" id="btnPrev" class="pagination-arrow" title="이전"><img src="{{ url_for('static', filename='images/left.png') }}" alt="이전"></button>
        <span class="pagination-numbers" id="pageNumbers"></span>
        <button type="button" id="btnNext" class="pagination-arrow" title="다음"><img src="{{ url_for('static', filename='images/right.png') }}" alt="다음"></button>
      </div>
    </div>
    </div>

    <div id="pageWavity" class="page-placeholder" style="display:none">
      여기는 창업관련 크롤링 데이터화면입니다
    </div>
  </div>

  {% include 'partials/_sidebar_users.html' %}

  <div id="toast" class="toast" style="display:none"></div>

  <div class="img-modal" id="imgModal">
    <img id="imgModalImg" src="" alt="확대">
  </div>

  {% include 'partials/_loading_overlay.html' %}
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="{{ url_for('static', filename='js/loading.js') }}"></script>
  <script>
    const PAGE_SIZE = 10;
    const SUPABASE_URL = {{ (supabase_url or '')|tojson }};
    const SUPABASE_ANON_KEY = {{ (supabase_anon_key or '')|tojson }};
    const tableBody = document.getElementById('tableBody');
    const toast = document.getElementById('toast');
    const pagination = document.getElementById('pagination');
    const pageNumbers = document.getElementById('pageNumbers');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const countdownEl = document.getElementById('countdown');
    const dateTimeEl = document.getElementById('currentDateTime');

    const REFRESH_INTERVAL_SEC = 30 * 60;
    let countdownSec = REFRESH_INTERVAL_SEC;
    let countdownTimer = null;

    function updateDateTime() {
      if (dateTimeEl) {
        const now = new Date();
        dateTimeEl.textContent = now.toLocaleString('ko-KR', {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit',
          hour12: false
        });
      }
    }

    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      countdownSec = REFRESH_INTERVAL_SEC;
      function fmt() {
        const m = Math.floor(countdownSec / 60);
        const s = countdownSec % 60;
        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      }
      if (countdownEl) countdownEl.textContent = `(다음 갱신까지 ${fmt()})`;
      countdownTimer = setInterval(() => {
        countdownSec--;
        if (countdownSec <= 0) countdownSec = REFRESH_INTERVAL_SEC;
        if (countdownEl) countdownEl.textContent = `(다음 갱신까지 ${fmt()})`;
      }, 1000);
    }

    updateDateTime();
    setInterval(updateDateTime, 1000);
    startCountdown();

    const VIEWED_KEY = 'allyoung_viewed';
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let bookmarkSet = new Set();

    function getDdaySortKey(dDay) {
      if (!dDay || typeof dDay !== 'string') return 500;
      const s = dDay.trim();
      const dayMatch = s.match(/(\d+)\s*일/);
      if (dayMatch) return parseInt(dayMatch[1], 10);
      const dMatch = s.match(/D-(\d+)/i);
      if (dMatch) return parseInt(dMatch[1], 10);
      if (s.includes('오늘') || s === 'D-day') return 0;
      if (s.includes('마감') && !s.includes('일')) return 999999;
      return 500;
    }

    function applyFiltersAndSort() {
      let list = [...allData];
      const q = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
      const cat = (document.getElementById('categorySelect')?.value || '').trim();
      const src = (document.getElementById('sourceSelect')?.value || '').trim();
      if (q) {
        list = list.filter(r =>
          (r.title || '').toLowerCase().includes(q) ||
          (r.host || '').toLowerCase().includes(q) ||
          (r.category || '').toLowerCase().includes(q)
        );
      }
      if (cat) list = list.filter(r => (r.category || '공모전') === cat);
      if (src) list = list.filter(r => (r.source || '요즘것들') === src);
      list.sort((a, b) => getDdaySortKey(a.d_day) - getDdaySortKey(b.d_day));
      filteredData = list;
      currentPage = 1;
      renderTable(filteredData, 1);
    }

    function populateFilterOptions() {
      const cats = [...new Set(allData.map(r => r.category || '공모전').filter(Boolean))].sort();
      const srcs = [...new Set(allData.map(r => r.source || '요즘것들').filter(Boolean))].sort();
      const catSelect = document.getElementById('categorySelect');
      const srcSelect = document.getElementById('sourceSelect');
      if (catSelect) {
        const cur = catSelect.value;
        catSelect.innerHTML = '<option value="">전체</option>' + cats.map(c => `<option value="${escapeHtml(c)}"${c === cur ? ' selected' : ''}>${escapeHtml(c)}</option>`).join('');
      }
      if (srcSelect) {
        const cur = srcSelect.value;
        srcSelect.innerHTML = '<option value="">전체</option>' + srcs.map(s => `<option value="${escapeHtml(s)}"${s === cur ? ' selected' : ''}>${escapeHtml(s)}</option>`).join('');
      }
    }

    function getViewedIds() {
      try {
        const raw = localStorage.getItem(VIEWED_KEY);
        return new Set(raw ? JSON.parse(raw) : []);
      } catch { return new Set(); }
    }
    function addViewedId(id) {
      const ids = getViewedIds();
      ids.add(id);
      localStorage.setItem(VIEWED_KEY, JSON.stringify([...ids]));
    }

    function showToast(msg, type = 'success') {
      toast.textContent = msg;
      toast.className = 'toast ' + type;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    function renderTable(data, page = 1) {
      if (!data || data.length === 0) {
        const isFiltered = allData.length > 0;
        tableBody.innerHTML = `
          <tr><td colspan="8" class="empty-state">
            <p>${isFiltered ? '검색·필터 조건에 맞는 공고가 없습니다.' : '저장된 공고가 없습니다.'}</p>
            <p>${isFiltered ? '다른 조건으로 검색해 보세요.' : '데이터는 30분마다 자동으로 갱신됩니다.'}</p>
          </td></tr>
        `;
        pagination.style.display = 'none';
        return;
      }
      const totalPages = Math.ceil(data.length / PAGE_SIZE);
      const start = (page - 1) * PAGE_SIZE;
      const pageData = data.slice(start, start + PAGE_SIZE);

      const viewedIds = getViewedIds();
      const bookmarkedKey = (s, c) => (s || '') + ':' + (c || '');
      const isBookmarked = (r) => bookmarkSet.has(bookmarkedKey(r.source, r.id));
      tableBody.innerHTML = pageData.map((row, idx) => {
        const no = start + idx + 1;
        const isViewed = viewedIds.has(row.id);
        const rowClass = isViewed ? 'row-viewed' : 'row-new';
        const statusHtml = isViewed
          ? '<span class="status-check">✓</span>'
          : '<span class="status-dot"></span>';
        const dClass = row.d_day?.includes('마감') ? 'urgent' : (row.d_day?.includes('오늘') ? 'today' : 'normal');
        const starClass = isBookmarked(row) ? 'bookmark-star bookmarked' : 'bookmark-star';
        const starChar = isBookmarked(row) ? '★' : '☆';
        return `
          <tr data-id="${escapeHtml(row.id)}" data-source="${escapeHtml(row.source || '')}" class="${rowClass}">
            <td><span class="${starClass}" data-source="${escapeHtml(row.source || '')}" data-contest-id="${escapeHtml(row.id)}" title="북마크">${starChar}</span></td>
            <td>${statusHtml}${no}</td>
            <td><span class="d-day ${dClass}">${escapeHtml(row.d_day || '-')}</span></td>
            <td class="title-cell cell-tooltip" data-tooltip="${escapeHtml(row.title || '')}">
              <a href="${escapeHtml(row.url)}" target="_blank" rel="noopener" data-id="${escapeHtml(row.id)}" data-url="${escapeHtml(row.url)}" class="title-link">${escapeHtml(row.title)}</a>
            </td>
            <td class="host-cell cell-tooltip" data-tooltip="${escapeHtml(row.host || '-')}">${escapeHtml(row.host || '-')}</td>
            <td>${escapeHtml(row.category || '공모전')}</td>
            <td>${escapeHtml(row.source || '요즘것들')}</td>
            <td>${formatFetchTime(row.created_at)}</td>
          </tr>
        `;
      }).join('');

      if (totalPages > 1) {
        pagination.style.display = 'flex';
        btnPrev.disabled = page <= 1;
        btnNext.disabled = page >= totalPages;

        let numHtml = '';
        for (let i = 1; i <= totalPages; i++) {
          if (i === page) {
            numHtml += `<button type="button" class="active" disabled>${i}</button>`;
          } else {
            numHtml += `<button type="button" data-page="${i}">${i}</button>`;
          }
        }
        pageNumbers.innerHTML = numHtml;
        pageNumbers.querySelectorAll('button[data-page]').forEach(b => {
          b.addEventListener('click', () => goToPage(parseInt(b.dataset.page)));
        });
      } else {
        pagination.style.display = 'none';
      }
    }

    function goToPage(page) {
      currentPage = page;
      renderTable(filteredData, currentPage);
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s ?? '';
      return d.innerHTML;
    }

    function formatFetchTime(iso) {
      if (!iso) return '-';
      try {
        const d = new Date(iso);
        if (isNaN(d)) return '-';
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const h = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        return `${m}/${day} ${h}:${min}`;
      } catch { return '-'; }
    }

    async function loadContests(showLoading = true) {
      if (showLoading) {
        if (typeof window.showLoading === 'function') window.showLoading();
        tableBody.innerHTML = '<tr><td colspan="8" class="loading">로딩 중</td></tr>';
        pagination.style.display = 'none';
      }
      try {
        const r = await fetch('/api/contests');
        const j = await r.json();
        console.log('[API /api/contests]', j);
        if (j.success && j.data) {
          allData = j.data;
          document.getElementById('filterBar').style.display = allData.length ? 'flex' : 'none';
          const br = await fetch('/api/bookmarks');
          const bj = await br.json();
          if (bj.success && bj.data) {
            bookmarkSet = new Set(bj.data.map(x => (x.source || '') + ':' + (x.contest_id || '')));
          }
          populateFilterOptions();
          applyFiltersAndSort();
        }
      } catch (e) {
        tableBody.innerHTML = '<tr><td colspan="8" class="empty-state">데이터를 불러올 수 없습니다.</td></tr>';
      } finally {
        if (showLoading && typeof window.hideLoading === 'function') window.hideLoading();
      }
    }

    function removeDetailRow() {
      const existing = tableBody.querySelector('tr.detail-row');
      if (existing) existing.remove();
    }

    async function toggleDetailRow(postId, url, title, clickedRow) {
      const next = clickedRow.nextElementSibling;
      if (next?.classList.contains('detail-row') && next.dataset.forId === postId) {
        next.remove();
        return;
      }
      removeDetailRow();
      addViewedId(postId);
      clickedRow.classList.remove('row-new');
      clickedRow.classList.add('row-viewed');
      const noCell = clickedRow.querySelector('td:nth-child(2)');
      if (noCell && !noCell.querySelector('.status-check')) {
        const num = (noCell.textContent.match(/\d+/) || [''])[0];
        noCell.innerHTML = '<span class="status-check">✓</span>' + num;
      }

      const detailTr = document.createElement('tr');
      detailTr.className = 'detail-row';
      detailTr.dataset.forId = postId;
      detailTr.innerHTML = '<td colspan="8"><div class="detail-inner"><div class="detail-loading">불러오는 중...</div></div><div class="detail-footer"></div></td>';
      clickedRow.after(detailTr);

      const inner = detailTr.querySelector('.detail-inner');
      const footer = detailTr.querySelector('.detail-footer');

      try {
        const r = await fetch('/api/post/' + postId);
        const j = await r.json();
        if (j.success && j.data) {
          const d = j.data;
          let meta = [];
          if (d.host) meta.push('주최/주관: ' + d.host);
          if (d.category) meta.push('카테고리: ' + d.category);
          if (d.apply_period) meta.push('접수기간: ' + d.apply_period);
          let imgHtml = '';
          if (d.images && d.images.length > 0) {
            imgHtml = '<div class="detail-images">' + d.images.map(u => '<img src="' + escapeHtml(u) + '" alt="" loading="lazy" class="detail-img">').join('') + '</div>';
          }
          inner.innerHTML = (meta.length ? '<div class="detail-meta">' + meta.join(' | ') + '</div>' : '') + imgHtml + escapeHtml(d.body || '(내용 없음)');
          footer.innerHTML = '<a href="' + escapeHtml(d.url) + '" target="_blank" rel="noopener" class="btn btn-primary">원문 보기</a>' + (d.apply_url ? ' <a href="' + escapeHtml(d.apply_url) + '" target="_blank" rel="noopener" class="btn btn-primary">지원하기</a>' : '');
        } else {
          inner.innerHTML = '<div class="detail-loading">' + (j.error || '내용을 불러올 수 없습니다.') + '</div>';
          footer.innerHTML = '<a href="' + escapeHtml(url) + '" target="_blank" rel="noopener" class="btn btn-primary">원문 보기</a>';
        }
      } catch (e) {
        inner.innerHTML = '<div class="detail-loading">연결 실패: ' + escapeHtml(e.message) + '</div>';
        footer.innerHTML = '<a href="' + escapeHtml(url) + '" target="_blank" rel="noopener" class="btn btn-primary">원문 보기</a>';
      }
    }

    const imgModal = document.getElementById('imgModal');
    const imgModalImg = document.getElementById('imgModalImg');
    function openImgModal(src) {
      imgModalImg.src = src;
      imgModal.classList.add('open');
    }
    function closeImgModal() {
      imgModal.classList.remove('open');
    }
    imgModal.addEventListener('click', closeImgModal);
    imgModalImg.addEventListener('click', (e) => e.stopPropagation());

    tableBody.addEventListener('click', async (e) => {
      const star = e.target.closest('.bookmark-star');
      if (star) {
        e.preventDefault();
        e.stopPropagation();
        const source = star.dataset.source || '요즘것들';
        const contestId = star.dataset.contestId || '';
        if (!contestId) return;
        try {
          const r = await fetch('/api/bookmarks/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source, contest_id: contestId })
          });
          const j = await r.json();
          if (j.success) {
            const key = source + ':' + contestId;
            if (j.bookmarked) {
              bookmarkSet.add(key);
              star.textContent = '★';
              star.classList.add('bookmarked');
              showToast('북마크에 추가했습니다');
            } else {
              bookmarkSet.delete(key);
              star.textContent = '☆';
              star.classList.remove('bookmarked');
              showToast('북마크에서 제거했습니다');
            }
          }
        } catch (err) {
          showToast('오류가 발생했습니다', 'error');
        }
        return;
      }
      const img = e.target.closest('img.detail-img');
      if (img) {
        e.preventDefault();
        openImgModal(img.src);
        return;
      }
      const a = e.target.closest('a.title-link');
      if (!a) return;
      e.preventDefault();
      const id = a.dataset.id;
      const url = a.dataset.url || a.href;
      const title = a.textContent;
      const row = a.closest('tr');
      if (id && row) toggleDetailRow(id, url, title, row);
      else window.open(url, '_blank');
    });

    document.querySelectorAll('.nav-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const page = a.dataset.page;
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        a.classList.add('active');
        document.getElementById('pageAllyoung').style.display = page === 'allyoung' ? 'block' : 'none';
        document.getElementById('pageWavity').style.display = page === 'wavity' ? 'block' : 'none';
      });
    });

    btnPrev.addEventListener('click', () => goToPage(currentPage - 1));
    btnNext.addEventListener('click', () => goToPage(currentPage + 1));

    document.getElementById('searchInput')?.addEventListener('input', () => applyFiltersAndSort());
    document.getElementById('searchInput')?.addEventListener('keyup', (e) => { if (e.key === 'Enter') applyFiltersAndSort(); });
    document.getElementById('categorySelect')?.addEventListener('change', () => applyFiltersAndSort());
    document.getElementById('sourceSelect')?.addEventListener('change', () => applyFiltersAndSort());

    loadContests();

    if (SUPABASE_URL && SUPABASE_ANON_KEY && typeof supabase !== 'undefined') {
      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      supabaseClient.channel('contests').on('postgres_changes', { event: '*', schema: 'public', table: 'contests' }, () => {
        loadContests(false);
      }).subscribe();
    }
  </script>
</body>
</html>
