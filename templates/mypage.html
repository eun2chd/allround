<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
  <title>{{ 'ë§ˆì´í˜ì´ì§€' if is_own_profile else (profile.get('nickname', '') or 'íšŒì›') + ' í”„ë¡œí•„' }} | Ntpercent</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
  <style>
    @font-face {
      font-family: 'Pretendard Variable';
      src: url("{{ url_for('static', filename='font/PretendardVariable.ttf') }}") format('truetype');
      font-weight: 100 900;
      font-style: normal;
    }
    :root {
      --main-purple: #6d28d9;
      --main-purple-hover: #5b21b6;
      --soft-purple: #ede9fe;
      --text-dark: #212121;
      --gray-muted: #9ca3af;
      --bg-white: #ffffff;
      --border-gray: #e5e7eb;
      --radius: 8px;
      --radius-lg: 12px;
      --font: 'Pretendard Variable', 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { overflow-x: hidden; scrollbar-gutter: stable; }
    body {
      font-family: var(--font);
      background: #f9fafb;
      color: var(--text-dark);
      font-weight: 500;
      min-height: 100vh;
      line-height: 1.5;
      overflow-x: hidden;
    }
    .main-wrap { margin-left: 260px; }
    .container { max-width: 960px; margin: 0 auto; padding: 24px; }
    .page-header {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-gray);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .page-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
      margin: 0;
    }
    /* ëŒ€í‘œ ì‘í’ˆ (Pinned Portfolio) */
    .pinned-portfolio-section {
      margin-bottom: 24px;
    }
    .pinned-portfolio-section h3 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-gray);
    }
    .pinned-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    @media (max-width: 768px) {
      .pinned-cards { grid-template-columns: 1fr; }
    }
    .pinned-card {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .pinned-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
    }
    .pinned-card-thumb {
      aspect-ratio: 4/3;
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      background-size: cover;
      background-position: center;
      position: relative;
    }
    .pinned-card-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      font-size: 0.7rem;
      font-weight: 700;
      color: #b45309;
      background: linear-gradient(180deg, #fef3c7, #fde68a);
      border: 1px solid #e8b923;
      border-radius: 20px;
    }
    .pinned-card-title {
      padding: 14px;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-dark);
    }
    .pinned-card-placeholder {
      opacity: 0.85;
      pointer-events: none;
    }
    /* ì¹´ë“œ ê³µí†µ */
    .card {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    /* ìš”ì•½ ëŒ€ì‹œë³´ë“œ */
    .dashboard-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 768px) {
      .dashboard-summary { grid-template-columns: 1fr; }
    }
    .summary-card {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .summary-card .summary-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .summary-card .summary-icon.trophy { background: linear-gradient(135deg, #fef3c7, #fde68a); }
    .summary-card .summary-icon.money { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
    .summary-card .summary-icon.rocket { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); }
    .summary-card .summary-value { font-size: 1.25rem; font-weight: 700; color: var(--text-dark); }
    .summary-card .summary-label { font-size: 0.85rem; color: var(--gray-muted); margin-top: 2px; }
    /* ì°¸ê°€/íŒ¨ìŠ¤ ê³µëª¨ì „ */
    .participation-section {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }
    .participation-section h3 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-gray);
    }
    .participation-list { display: flex; flex-direction: column; gap: 12px; }
    .participation-item-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: #faf9fc;
      border-radius: var(--radius);
      border: 1px solid var(--border-gray);
      transition: background 0.2s, border-color 0.2s;
    }
    .participation-item-wrap:hover { border-color: rgba(109,40,217,0.3); }
    .participation-item {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
      text-decoration: none;
      color: inherit;
    }
    .participation-item-wrap:hover .participation-item { background: transparent; }
    .participation-item-wrap:hover { background: var(--soft-purple); }
    .participation-delete-btn {
      flex-shrink: 0;
      padding: 4px 10px;
      border: 1px solid #dc2626;
      background: transparent;
      color: #dc2626;
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
    }
    .participation-delete-btn:hover { background: rgba(220, 38, 38, 0.1); }
    .participation-pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-gray);
    }
    .participation-pagination button {
      padding: 6px 12px;
      border: 1px solid var(--border-gray);
      background: var(--bg-white);
      color: var(--text-dark);
      font-size: 0.85rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .participation-pagination button:hover:not(:disabled) {
      border-color: var(--main-purple);
      color: var(--main-purple);
    }
    .participation-pagination button:disabled { opacity: 0.5; cursor: default; }
    .participation-pagination .participation-pages { display: flex; gap: 4px; }
    .participation-pagination .participation-page-btn {
      min-width: 32px;
      padding: 6px 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-dark);
      font-size: 0.85rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .participation-pagination .participation-page-btn:hover { background: var(--soft-purple); }
    .participation-pagination .participation-page-btn.active {
      border-color: var(--main-purple);
      background: var(--soft-purple);
      color: var(--main-purple);
      font-weight: 600;
    }
    .participation-badge {
      flex-shrink: 0;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .participation-badge.participate { background: #d1fae5; color: #059669; }
    .participation-badge.pass { background: #e5e7eb; color: #6b7280; }
    .participation-info { flex: 1; min-width: 0; }
    .participation-title { font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-bottom: 4px; }
    .participation-meta { font-size: 0.8rem; color: var(--gray-muted); }
    .actions-section {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      padding-top: 24px;
      border-top: 1px solid var(--border-gray);
    }
    .btn-outline {
      padding: 12px 24px;
      font-family: var(--font);
      font-size: 0.95rem;
      font-weight: 500;
      background: var(--bg-white);
      color: var(--main-purple);
      border: 2px solid var(--main-purple);
      border-radius: var(--radius);
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.2s;
    }
    .btn-outline:hover {
      background: var(--soft-purple);
    }
    .btn-outline.danger {
      color: #dc2626;
      border-color: #dc2626;
    }
    .btn-outline.danger:hover {
      background: #fef2f2;
    }
    /* ì•ˆë‚´ ë²„íŠ¼ */
    .info-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn-info {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--soft-purple);
      color: var(--main-purple);
      border: 1px solid rgba(109,40,217,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-info:hover {
      background: var(--main-purple);
      color: #fff;
      border-color: var(--main-purple);
    }
    .btn-info svg { width: 18px; height: 18px; }
    /* ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      max-width: 480px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 24px 48px rgba(0,0,0,0.15);
    }
    #modalProfileTheme .modal-box {
      max-width: min(1200px, 95vw);
      width: min(1200px, 95vw);
      max-height: none;
      overflow: visible;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-gray);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .modal-header h4 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-dark);
      margin: 0;
    }
    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--gray-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: color 0.2s;
    }
    .modal-close:hover { color: var(--text-dark); }
    .modal-body {
      padding: 24px;
      font-size: 0.9rem;
      line-height: 1.7;
      color: var(--text-dark);
    }
    .modal-body table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin: 16px 0;
    }
    .modal-body th, .modal-body td {
      padding: 10px 12px;
      text-align: left;
      border: 1px solid var(--border-gray);
    }
    .modal-body th {
      background: var(--soft-purple);
      color: var(--main-purple);
      font-weight: 600;
    }
    .modal-body .info-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-gray);
    }
    .modal-body .info-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .modal-body .info-item strong { color: var(--main-purple); }
    @media (max-width: 1200px) {
      .sidebar-team { display: none; }
      .main-wrap { margin-left: 0; }
    }
  </style>
</head>
<body>
  {% include 'partials/_navbar.html' %}
  {% include 'partials/_sidebar_team.html' %}

  <div class="main-wrap">
  <div class="container">
    <header class="page-header">
      <h1>{{ 'ë§ˆì´í˜ì´ì§€' if is_own_profile else 'í”„ë¡œí•„' }}</h1>
      <div class="info-buttons">
        {% if is_own_profile %}
        <button type="button" class="btn-profile-apply" onclick="openModal('modalProfileTheme')" title="í”„ë¡œí•„ í…Œë§ˆ ì„ íƒ">í”„ë¡œí•„ ì ìš©</button>
        <button type="button" class="btn-info" onclick="openModal('modalTier')" title="í‹°ì–´ ì‹œìŠ¤í…œ ì•ˆë‚´">ğŸ†</button>
        <button type="button" class="btn-info" onclick="openModal('modalHashtags')" title="í•´ì‹œíƒœê·¸ ì„ íƒ">#</button>
        <button type="button" class="btn-info" onclick="openModal('modalHeadline')" title="í—¤ë“œë¼ì¸ ì•ˆë‚´">âœ¨</button>
        {% endif %}
        {% if not is_own_profile %}
        <a href="{{ url_for('home') }}" class="btn-outline">í™ˆìœ¼ë¡œ</a>
        {% endif %}
      </div>
    </header>

    <!-- í”„ë¡œí•„ ì˜ì—­ (Tier tier-0~4, í…Œë§ˆ profile-theme-* ì ìš©) -->
    <section class="profile-section tier-{{ tier_level }}" id="profileSection" data-own-profile="{{ '1' if is_own_profile else '0' }}">
      {% if tier_level >= 3 %}
      <div class="platinum-shine-overlay"></div>
      {% endif %}
      {% if tier_level >= 4 %}
      <div class="legend-light-overlay" aria-hidden="true"></div>
      {% endif %}
      {% if tier_level >= 2 %}
      <svg class="profile-border-svg" viewBox="0 0 500 300" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="goldSectionGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#e8b923" />
            <stop offset="50%" stop-color="#fcd34d" />
            <stop offset="100%" stop-color="#fde68a" />
          </linearGradient>
          <linearGradient id="rainbowSectionGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#f59e0b" />
            <stop offset="25%" stop-color="#ec4899" />
            <stop offset="50%" stop-color="#8b5cf6" />
            <stop offset="75%" stop-color="#06b6d4" />
            <stop offset="100%" stop-color="#f59e0b" />
          </linearGradient>
          <linearGradient id="pinkSectionGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#831843" />
            <stop offset="50%" stop-color="#ec4899" />
            <stop offset="100%" stop-color="#be185d" />
          </linearGradient>
        </defs>
        <rect x="1.5" y="1.5" width="497" height="297" rx="12" ry="12" />
      </svg>
      {% endif %}
      {% if tier_level >= 3 %}
      <div class="tier-particles">
        <span class="tier-particle"></span><span class="tier-particle"></span><span class="tier-particle"></span>
        <span class="tier-particle"></span><span class="tier-particle"></span><span class="tier-particle"></span>
      </div>
      {% endif %}
      <div class="profile-top">
        <div class="avatar-wrap">
          <div class="avatar {% if tier_level >= 2 %}legend-border{% endif %}{% if not profile.get('profile_url') %} avatar-no-image{% endif %}" id="profileAvatar" style="background-image: url('{{ profile.get('profile_url') or '' }}')">
            {% if not profile.get('profile_url') %}<span>{{ (profile.get('nickname') or '?')[:1] }}</span>{% endif %}
          </div>
          {% if tier_level >= 4 %}
          <span class="symbol-badge-medal" aria-hidden="true"></span>
          {% endif %}
          {% if is_own_profile %}
          <label class="btn-avatar-upload" title="í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½">
            <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/gif,image/webp">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          </label>
          {% endif %}
        </div>
        <div class="info">
          <h2>
            {{ profile.get('nickname', '') or 'íšŒì›' }}
            <span class="role-badge">{{ role_label }}</span>
          </h2>
          <div class="headline-badges">
            {% for headline in auto_headlines %}
            <span class="headline-badge headline-badge-{{ loop.index }}"><span class="headline-badge-dot"></span>{{ headline }}</span>
            {% endfor %}
          </div>
          <div class="hashtag-row" id="userHashtagsContainer">
            {% for h in user_hashtags or [] %}
            <span class="hashtag-badge">#{{ h.tag_name }}</span>
            {% endfor %}
            {% if is_own_profile and level >= 71 %}
            <button type="button" class="hashtag-add-btn" onclick="openModal('modalHashtags')" title="í•´ì‹œíƒœê·¸ ì¶”ê°€">
              <span class="hashtag-add-icon">+</span> í•´ì‹œíƒœê·¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”
            </button>
            {% endif %}
          </div>
          {% if is_own_profile %}
          <p style="font-size:0.85rem;color:var(--gray-muted);margin-top:8px;">{{ profile.get('email', '') }}</p>
          {% endif %}
        </div>
        {% if is_own_profile %}
        <a href="{{ url_for('mypage_password') }}" class="btn-outline profile-logout">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
        {% endif %}
      </div>
      <!-- ë ˆë²¨/EXP ë°”: ì¢Œì¸¡ ì— ë¸”ëŸ¼ + ìš°ì¸¡ ì„±ì¥ ì •ë³´ -->
      <div class="level-exp-block">
        <div class="level-exp-row">
          <div class="level-exp-emblem">
            <span class="tier-sprite tier-sprite-profile tier-sprite-{{ tier_sprite }}" aria-hidden="true"></span>
          </div>
          <div class="level-exp-info-col">
            <div class="level-tier-line">
              <span class="level-text">Lv.{{ level }}</span>
              <span class="tier-badge-pill tier-badge-pill-{{ tier_name|lower }}">{{ tier_name }}</span>
              <button type="button" class="btn-tier-exp" onclick="openModal('modalTierExp')" title="í‹°ì–´ë³„ ë„ë‹¬ ê²½í—˜ì¹˜">EXP</button>
            </div>
            <p class="level-total-exp">ì´ {{ total_exp|default(profile.get('total_exp', 0)) }} EXP</p>
            <div class="exp-bar-wrap">
              <div class="exp-bar-fill {% if tier_level >= 3 %}legend{% elif tier_level >= 2 %}gold{% endif %}" style="width: {{ [exp_percent, 100]|min }}%"></div>
            </div>
            <p class="exp-next-hint">{% if exp_next <= 0 %}ìµœê³  ë ˆë²¨ ë‹¬ì„±{% elif exp_current >= exp_next or exp_percent >= 100 %}ë‹¤ìŒ ë ˆë²¨ ë„ë‹¬! ({{ exp_percent }}% ì™„ë£Œ){% else %}ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ {{ exp_next - exp_current }} EXP í•„ìš” ({{ exp_percent }}% ì™„ë£Œ){% endif %}</p>
          </div>
        </div>
      </div>
      {% if is_own_profile %}
      <div class="profile-status-row">
        <div class="status-row-inner">
          <input type="text" class="status-input" id="statusInput" value="{{ profile.get('status_message') or '' }}" placeholder="ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì´ë²ˆ ì£¼ OO ê³µëª¨ì „ ë§ˆê°ì…ë‹ˆë‹¤!)" maxlength="80">
          <button type="button" class="btn-save-status" id="btnSaveStatus" title="ì €ì¥">ì €ì¥</button>
          <button type="button" class="btn-clear-status" id="btnClearStatus" title="ìƒíƒœ ë©”ì‹œì§€ ì‚­ì œ">ì‚­ì œ</button>
        </div>
      </div>
      {% endif %}
    </section>

    <!-- ëŒ€í‘œ ì‘í’ˆ (Pinned Portfolio) -->
    <section class="pinned-portfolio-section">
      <h3>ëŒ€í‘œ ì‘í’ˆ</h3>
      <div class="pinned-cards">
        {% set filler = [{'title':'ëŒ€í‘œ ì‘í’ˆ','award':'ìˆ˜ìƒ','url':'#','thumbnail':''}] * 3 %}
        {% set items = (pinned_portfolio or []) + filler %}
        {% for item in items[:3] %}
        <a href="{{ item.url or '#' }}" class="pinned-card{% if not item.thumbnail %} pinned-card-placeholder{% endif %}" target="_blank">
          <div class="pinned-card-thumb" style="{% if item.thumbnail %}background-image: url('{{ item.thumbnail }}');{% endif %}">
            <span class="pinned-card-badge">{{ item.award or 'ìˆ˜ìƒ' }}</span>
          </div>
          <div class="pinned-card-title">{{ item.title or 'ì‘í’ˆ ì œëª©' }}</div>
        </a>
        {% endfor %}
      </div>
    </section>

    <!-- ìš”ì•½ ëŒ€ì‹œë³´ë“œ (DB ì—°ë™) -->
    <section class="dashboard-summary">
      <div class="summary-card">
        <div class="summary-icon trophy">ğŸ†</div>
        <div>
          <div class="summary-value">{{ awards_count|default(0) }}ê±´</div>
          <div class="summary-label">ìˆ˜ìƒ</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon money">ğŸ’°</div>
        <div>
          <div class="summary-value">{{ prize_total|default('0') }}</div>
          <div class="summary-label">ìƒê¸ˆ</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon rocket">ğŸš€</div>
        <div>
          <div class="summary-value">{{ participate_count|default(0) }}ê±´</div>
          <div class="summary-label">ë„ì „</div>
        </div>
      </div>
    </section>

    <!-- ì°¸ê°€/íŒ¨ìŠ¤ ê³µëª¨ì „ (ë³¸ì¸Â·íƒ€ì¸ í”„ë¡œí•„ ëª¨ë‘ í‘œì‹œ, 5ê°œì”© ìµœëŒ€ 10í˜ì´ì§€) -->
    <section class="participation-section" id="participationSection" data-user-id="{{ profile.get('id', '') }}" data-own-profile="{{ '1' if is_own_profile else '0' }}">
      <h3>ì°¸ê°€ / íŒ¨ìŠ¤ ê³µëª¨ì „</h3>
      <div class="participation-list" id="participationList">
        <div class="participation-loading" id="participationLoading" style="color:var(--gray-muted);padding:24px;text-align:center;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
      <div class="participation-pagination" id="participationPagination" style="display:none">
        <button type="button" class="participation-prev" id="participationPrev" title="ì´ì „">ì´ì „</button>
        <span class="participation-pages" id="participationPages"></span>
        <button type="button" class="participation-next" id="participationNext" title="ë‹¤ìŒ">ë‹¤ìŒ</button>
      </div>
    </section>
  </div>
  </div>

  <!-- ì•ˆë‚´ ëª¨ë‹¬: í‹°ì–´ ì‹œìŠ¤í…œ -->
  <div class="modal-overlay" id="modalTier">
    <div class="modal-box modal-tier-info">
      <div class="modal-header">
        <h4>ğŸ† ë ˆë²¨Â·í‹°ì–´ ì‹œìŠ¤í…œ</h4>
        <button type="button" class="modal-close" onclick="closeModal('modalTier')" aria-label="ë‹«ê¸°">Ã—</button>
      </div>
      <div class="modal-body">
        <p>ê²½í—˜ì¹˜ë¥¼ ìŒ“ì•„ ë ˆë²¨ì—…í•˜ë©´ í‹°ì–´ê°€ ì˜¬ë¼ê°€ê³ , í”„ë¡œí•„ ë¹„ì£¼ì–¼ì´ ì—…ê·¸ë ˆì´ë“œë©ë‹ˆë‹¤.</p>
        <table class="tier-table">
          <thead><tr><th>Tier</th><th>ë ˆë²¨ êµ¬ê°„</th><th>íš¨ê³¼</th></tr></thead>
          <tbody>
            <tr><td>BRONZE</td><td>Lv.1~20</td><td>ê¸°ë³¸ í° ë°°ê²½</td></tr>
            <tr><td>SILVER</td><td>Lv.21~70</td><td>ì‹¤ë²„ í…Œë‘ë¦¬ + ì•„ë°”íƒ€ ì‹¤ë²„ ê¸€ë¡œìš°</td></tr>
            <tr><td>GOLD</td><td>Lv.71~120</td><td>ê³¨ë“œ ë°°ê²½ + íšŒì „ ê³¨ë“œ ë³´ë” + shimmer íš¨ê³¼</td></tr>
            <tr><td>PLATINUM</td><td>Lv.121~140</td><td>ë‹¤í¬ ë°°ê²½ + íŒŒí‹°í´ + ë¬´ì§€ê°œ ë³´ë”</td></tr>
            <tr><td>LEGEND</td><td>Lv.141~</td><td>ìµœê³  ë“±ê¸‰ + ë ˆì „ë“œ ë±ƒì§€</td></tr>
          </tbody>
        </table>
        <h5 class="tier-desc-title">í”„ë¡œí•„ë³„ ì„¤ëª…</h5>
        <div class="tier-desc-list">
          <div class="tier-desc-item tier-desc-bronze">
            <div class="tier-desc-header"><span class="tier-dot">ğŸŸ¤</span> BRONZE â€“ ë‰´ë¹„ìŠ¤íƒ€íŠ¸ í”„ë¡œí•„</div>
            <div class="tier-desc-tagline">"ë„ì „ì˜ ì‹œì‘"</div>
            <p>ê¸°ë³¸ ê³µëª¨ì „ í™œë™ì„ í†µí•´ ë‹¤ì–‘í•œ ê²½í—˜ì„ ìŒ“ì•„ê°€ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. ì‹œí–‰ì°©ì˜¤ë¥¼ í†µí•´ ë°°ìš°ë©°, ìì‹ ë§Œì˜ ë°©í–¥ì„±ì„ íƒìƒ‰í•©ë‹ˆë‹¤. ë„ì „ì„ ì‹œì‘í•œ ì„±ì¥í˜• ì¸ì¬ì…ë‹ˆë‹¤.</p>
          </div>
          <div class="tier-desc-item tier-desc-silver">
            <div class="tier-desc-header"><span class="tier-dot">âšª</span> SILVER â€“ ì´ˆì‹¬ì ìŠ¤íƒ€íŠ¸ í”„ë¡œí•„</div>
            <div class="tier-desc-tagline">"ê²½í—˜ì˜ ì¶•ì "</div>
            <p>ê³µëª¨ì „ ì°¸ì—¬ê°€ ìµìˆ™í•´ì§€ê³ , íë¦„ì„ ì´í•´í•˜ê¸° ì‹œì‘í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. ê¸°íšê³¼ ì¤€ë¹„ ê³¼ì •ì´ ì²´ê³„í™”ë˜ë©° ì‹¤ì „ ê°ê°ì´ í˜•ì„±ë©ë‹ˆë‹¤. ë„ì „ì„ ë°˜ë³µí•˜ë©° ë‚´ê³µì„ ìŒ“ëŠ” ì„±ì¥ ë‹¨ê³„ì…ë‹ˆë‹¤.</p>
          </div>
          <div class="tier-desc-item tier-desc-gold">
            <div class="tier-desc-header"><span class="tier-dot">ğŸŸ¡</span> GOLD â€“ ë„ì „ í™•ì¥ í”„ë¡œí•„</div>
            <div class="tier-desc-tagline">"ì„±ê³¼ì˜ ê°€ì‹œí™”"</div>
            <p>ë‹¨ìˆœ ì°¸ì—¬ë¥¼ ë„˜ì–´ ê²°ê³¼ë¥¼ ë§Œë“¤ì–´ë‚´ê¸° ì‹œì‘í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. ì „ëµì  ì ‘ê·¼ê³¼ ì™„ì„±ë„ê°€ ëˆˆì— ë„ë©°, ê²½ìŸë ¥ì„ ê°–ì¶”ê¸° ì‹œì‘í•©ë‹ˆë‹¤. ì‹¤ì§ˆì ì¸ ì„±ê³¼ê°€ ì¶•ì ë˜ëŠ” êµ¬ê°„ì…ë‹ˆë‹¤.</p>
          </div>
          <div class="tier-desc-item tier-desc-platinum">
            <div class="tier-desc-header"><span class="tier-dot">ğŸ”µ</span> PLATINUM â€“ ì„±ê³¼ ì „ë¬¸ í”„ë¡œí•„</div>
            <div class="tier-desc-tagline">"ê²€ì¦ëœ ì‹¤ë ¥"</div>
            <p>ì§€ì†ì ì¸ ë„ì „ê³¼ ì„±ê³¼ë¥¼ í†µí•´ ì—­ëŸ‰ì´ ê²€ì¦ëœ ë‹¨ê³„ì…ë‹ˆë‹¤. ê¸°íšë ¥, ì‹¤í–‰ë ¥, ì™„ì„±ë„ì—ì„œ ì•ˆì •ì ì¸ ìˆ˜ì¤€ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. ê³µëª¨ì „ í™œë™ì„ ì „ëµì ìœ¼ë¡œ ì„¤ê³„í•˜ëŠ” ìˆ˜ì¤€ì— ë„ë‹¬í•©ë‹ˆë‹¤.</p>
          </div>
          <div class="tier-desc-item tier-desc-legend">
            <div class="tier-desc-header"><span class="tier-dot">ğŸŸ£</span> LEGEND â€“ ìµœê³  ì„±ì·¨ í”„ë¡œí•„</div>
            <div class="tier-desc-tagline">"ì˜í–¥ë ¥ ìˆëŠ” ì„±ì·¨ì"</div>
            <p>ë›°ì–´ë‚œ ì„±ê³¼ì™€ ì§€ì†ì ì¸ í™œë™ì„ í†µí•´ ìƒìœ„ê¶Œ ì—­ëŸ‰ì„ ì…ì¦í•œ ë‹¨ê³„ì…ë‹ˆë‹¤. ë‹¨ìˆœ ì°¸ì—¬ë¥¼ ë„˜ì–´, ê²°ê³¼ì™€ ì˜í–¥ë ¥ì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤. ì»¤ë®¤ë‹ˆí‹° ë‚´ì—ì„œ ê¸°ì¤€ì´ ë˜ëŠ” ì„±ì·¨ìì…ë‹ˆë‹¤.</p>
          </div>
        </div>
        <p style="font-size:0.85rem;color:var(--gray-muted);margin-top:16px;">ì°¸ê°€Â·í™œë™ ì‹œ ê²½í—˜ì¹˜ë¥¼ ì–»ê³ , ë ˆë²¨ì—… ì‹œ ë” í™”ë ¤í•œ í”„ë¡œí•„ì„ ê°–ê²Œ ë©ë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>

  <!-- í‹°ì–´ë³„ ë„ë‹¬ ê²½í—˜ì¹˜ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="modalTierExp">
    <div class="modal-box modal-tier-exp">
      <div class="modal-header">
        <h4>ì „ì²´ ë ˆë²¨ &amp; í‹°ì–´ë³„ ë„ë‹¬ ì´ ê²½í—˜ì¹˜</h4>
        <button type="button" class="modal-close" onclick="closeModal('modalTierExp')" aria-label="ë‹«ê¸°">Ã—</button>
      </div>
      <div class="modal-body">
        <table class="tier-exp-table">
          <thead>
            <tr>
              <th>í‹°ì–´</th>
              <th>ì „ì²´ ë ˆë²¨ êµ¬ê°„</th>
              <th>í•´ë‹¹ í‹°ì–´ ë„ë‹¬ ì´ ê²½í—˜ì¹˜</th>
            </tr>
          </thead>
          <tbody>
            {% for m in tier_exp_milestones or [] %}
            <tr class="tier-row tier-row-{{ m.tier|lower }}">
              <td><span class="tier-badge-pill tier-badge-pill-{{ m.tier|lower }}">{{ m.tier }}</span></td>
              <td>{{ m.level_range }}</td>
              <td class="tier-exp-value">{{ (m.exp or 0)|int }} EXP</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p class="tier-exp-foot">í˜„ì¬ ì´ ê²½í—˜ì¹˜: <strong>{{ total_exp|default(profile.get('total_exp', 0)) }}</strong> EXP</p>
      </div>
    </div>
  </div>

  <!-- í•´ì‹œíƒœê·¸ ì„ íƒ ëª¨ë‹¬ (ê³¨ë“œ ì´ìƒ) -->
  <div class="modal-overlay" id="modalHashtags">
    <div class="modal-box modal-hashtags">
      <div class="modal-header">
        <h4># í•´ì‹œíƒœê·¸ ì„ íƒ</h4>
        <button type="button" class="modal-close" onclick="closeModal('modalHashtags')" aria-label="ë‹«ê¸°">Ã—</button>
      </div>
      <div class="modal-body">
        {% if level >= 71 %}
        <p class="hashtag-desc">ì›í•˜ëŠ” í•´ì‹œíƒœê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”. <strong>ìµœëŒ€ {{ hashtag_max_limit|default(5) }}ê°œ</strong>ê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <form id="hashtagForm">
          {% for category in (hashtag_category_order or (hashtag_master_by_category or {})|list) %}
          {% set tags = (hashtag_master_by_category or {}).get(category, []) %}
          {% if tags %}
          <div class="hashtag-category">
            <h5 class="hashtag-category-title">{{ category }}</h5>
            <div class="hashtag-chips">
              {% for t in tags %}
              <label class="hashtag-chip">
                <input type="checkbox" name="hashtag_id" value="{{ t.id }}" {% if t.id in (selected_hashtag_ids or []) %}checked{% endif %}>
                <span>#{{ t.tag_name }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </form>
        <div class="hashtag-actions">
          <span class="hashtag-count" id="hashtagCount">0 / {{ hashtag_max_limit|default(5) }}</span>
          <button type="button" class="btn-save-hashtags" id="btnSaveHashtags">ì €ì¥</button>
        </div>
        {% else %}
        <p class="tags-tier-notice">í•´ì‹œíƒœê·¸ëŠ” ê³¨ë“œ ë“±ê¸‰(Lv.71) ì´ìƒë¶€í„° ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ì•ˆë‚´ ëª¨ë‹¬: ìë™ í—¤ë“œë¼ì¸ -->
  <div class="modal-overlay" id="modalHeadline">
    <div class="modal-box modal-headline-info">
      <div class="modal-header">
        <h4>ìë™ ìƒì„± í—¤ë“œë¼ì¸</h4>
        <button type="button" class="modal-close" onclick="closeModal('modalHeadline')" aria-label="ë‹«ê¸°">Ã—</button>
      </div>
      <div class="modal-body">
        <p>ì—­ëŸ‰ì´ ìŒ“ì´ë©´ í”„ë¡œí•„ì— ë…¸ì¶œë˜ëŠ” í•œ ì¤„ ìê¸°ì†Œê°œê°€ ìë™ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œë©ë‹ˆë‹¤.</p>
        <div class="headline-tier-list">
          <div class="headline-tier-item">
            <div class="headline-tier-header"><span class="tier-dot">ğŸŸ¤</span> BRONZE (Lv.1~20) â€” ìë™ í—¤ë“œë¼ì¸ 1ì¢…</div>
        
            <ul><li>ìƒˆë¡œìš´ ë„ì „ì„ ì‹œì‘í•˜ëŠ” í¬ë¦¬ì—ì´í„°</li></ul>
          </div>
          <div class="headline-tier-item">
            <div class="headline-tier-header"><span class="tier-dot">âšª</span> SILVER (Lv.21~70) â€” ìë™ í—¤ë“œë¼ì¸ 2ì¢…</div>
    
            <ul><li>ê¾¸ì¤€íˆ ë„ì „í•˜ë©° ì„±ì¥ ì¤‘ì¸ í¬ë¦¬ì—ì´í„°</li><li>ê²½í—˜ì„ ìŒ“ì•„ê°€ëŠ” ì‹¤ì „í˜• ë„ì „ì</li></ul>
          </div>
          <div class="headline-tier-item">
            <div class="headline-tier-header"><span class="tier-dot">ğŸŸ¡</span> GOLD (Lv.71~120) â€” ìë™ í—¤ë“œë¼ì¸ 3ì¢…</div>
       
            <ul><li>ì„±ê³¼ë¥¼ ë§Œë“¤ì–´ë‚´ëŠ” ì „ëµí˜• í¬ë¦¬ì—ì´í„°</li><li>ê²½í—˜ì„ ì‹¤ë ¥ìœ¼ë¡œ ì¦ëª…í•˜ëŠ” ë„ì „ì</li><li>ê²½ìŸ ì†ì—ì„œ ê²°ê³¼ë¥¼ ë‚¨ê¸°ëŠ” í¬ë¦¬ì—ì´í„°</li></ul>
          </div>
          <div class="headline-tier-item">
            <div class="headline-tier-header"><span class="tier-dot">ğŸ”µ</span> PLATINUM (Lv.121~140) â€” ìë™ í—¤ë“œë¼ì¸ 4ì¢…</div>
      
            <ul><li>ê²€ì¦ëœ ì„±ê³¼ë¥¼ ë³´ìœ í•œ ìƒìœ„ê¶Œ í¬ë¦¬ì—ì´í„°</li><li>ì „ëµê³¼ ì‹¤í–‰ì„ ê²¸ë¹„í•œ í”„ë¡œì íŠ¸ ë¦¬ë”í˜•</li><li>ê¾¸ì¤€í•œ ìˆ˜ìƒê³¼ ê²°ê³¼ë¡œ ì¦ëª…í•˜ëŠ” ì „ë¬¸ê°€</li><li>ê²½ìŸì„ ì¦ê¸°ëŠ” ì‹¤ì „ ìµœì í™”í˜• ì¸ì¬</li></ul>
          </div>
          <div class="headline-tier-item">
            <div class="headline-tier-header"><span class="tier-dot">ğŸŸ£</span> LEGEND (Lv.141+) â€” ìë™ í—¤ë“œë¼ì¸ 5ì¢…</div>
            <ul><li>ìµœê³  ë“±ê¸‰ì˜ ì„±ì·¨ë¥¼ ë³´ìœ í•œ ë ˆì „ë“œ í¬ë¦¬ì—ì´í„°</li><li>ì˜í–¥ë ¥ì„ ë§Œë“œëŠ” ìµœìƒìœ„ ì„±ê³¼ì</li><li>ê²°ê³¼ë¡œ ì¦ëª…ëœ ìµœê³  ìˆ˜ì¤€ì˜ ë„ì „ì</li><li>ê¸°ì¤€ì´ ë˜ëŠ” í¼í¬ë¨¼ìŠ¤ í¬ë¦¬ì—ì´í„°</li><li>ë„ì „ì„ ë„˜ì–´ ì„±ì·¨ë¥¼ ì„¤ê³„í•˜ëŠ” ìƒìœ„ 1%</li></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- í”„ë¡œí•„ í…Œë§ˆ ìƒì  ëª¨ë‹¬ -->
  <div class="modal-overlay" id="modalProfileTheme">
    <div class="modal-box modal-profile-theme">
      <div class="modal-header">
        <h4>í”„ë¡œí•„ í…Œë§ˆ ìƒì </h4>
        <button type="button" class="modal-close" onclick="closeModal('modalProfileTheme')" aria-label="ë‹«ê¸°">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="profile-theme-desc">í˜„ì¬ í‹°ì–´ì— í•´ë‹¹í•˜ëŠ” íŠ¹ë³„í•œ í”„ë¡œí•„ì„ ì ìš©í•´ ë³´ì„¸ìš”! âœ¨</p>
        <div class="profile-theme-grid" data-user-level="{{ level }}">
          <div class="profile-theme-card" data-theme="basic" data-level-required="1">
            <div class="theme-preview theme-basic">
              <div class="theme-preview-avatar"></div>
              <div class="theme-preview-bar"></div>
              <div class="theme-lock-overlay" style="display:none"><img src="{{ url_for('static', filename='images/lock.png') }}" alt="ì ê¸ˆ" class="theme-lock-img"><span class="theme-lock-msg">ë ˆë²¨ ì¡°ê±´ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span></div>
            </div>
            <div class="theme-info">
              <span class="theme-level">Lv.1 BRONZE</span>
              <span class="theme-name">ë¸Œë¡ ì¦ˆ í”„ë¡œí•„</span>
              <p class="theme-desc">"ë„ì „ì˜ ì‹œì‘" Â· BRONZE ë“±ê¸‰ì…ë‹ˆë‹¤.</p>
              <button type="button" class="theme-apply-btn">ì ìš©í•˜ê¸°</button>
            </div>
          </div>
          <div class="profile-theme-card" data-theme="rare" data-level-required="21">
            <div class="theme-preview theme-rare">
              <div class="theme-preview-avatar"></div>
              <div class="theme-preview-bar"></div>
              <div class="theme-lock-overlay" style="display:none"><img src="{{ url_for('static', filename='images/lock.png') }}" alt="ì ê¸ˆ" class="theme-lock-img"><span class="theme-lock-msg">ë ˆë²¨ ì¡°ê±´ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span></div>
            </div>
            <div class="theme-info">
              <span class="theme-level">Lv.21 SILVER</span>
              <span class="theme-name">ê²½í—˜ì¶•ì  í”„ë¡œí•„</span>
              <p class="theme-desc">"ê²½í—˜ì˜ ì¶•ì " Â· SILVER ë“±ê¸‰ì…ë‹ˆë‹¤.</p>
              <button type="button" class="theme-apply-btn">ì ìš©í•˜ê¸°</button>
            </div>
          </div>
          <div class="profile-theme-card" data-theme="epic" data-level-required="71">
            <div class="theme-preview theme-epic">
              <div class="theme-mini-particle"></div>
              <div class="theme-preview-avatar"></div>
              <div class="theme-preview-bar"></div>
              <div class="theme-lock-overlay" style="display:none"><img src="{{ url_for('static', filename='images/lock.png') }}" alt="ì ê¸ˆ" class="theme-lock-img"><span class="theme-lock-msg">ë ˆë²¨ ì¡°ê±´ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span></div>
            </div>
            <div class="theme-info">
              <span class="theme-level">Lv.71 GOLD</span>
              <span class="theme-name">ë„ì „í™•ì¥ í”„ë¡œí•„</span>
              <p class="theme-desc">"ì„±ê³¼ì˜ ê°€ì‹œí™”" Â· GOLD ë“±ê¸‰ì…ë‹ˆë‹¤.</p>
              <button type="button" class="theme-apply-btn">ì ìš©í•˜ê¸°</button>
            </div>
          </div>
          <div class="profile-theme-card" data-theme="platinum" data-level-required="121">
            <div class="theme-preview theme-platinum">
              <div class="theme-preview-avatar"></div>
              <div class="theme-preview-bar"></div>
              <div class="theme-lock-overlay" style="display:none"><img src="{{ url_for('static', filename='images/lock.png') }}" alt="ì ê¸ˆ" class="theme-lock-img"><span class="theme-lock-msg">ë ˆë²¨ ì¡°ê±´ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span></div>
            </div>
            <div class="theme-info">
              <span class="theme-level">Lv.121 PLATINUM</span>
              <span class="theme-name">ì„±ê³¼ì „ë¬¸ í”„ë¡œí•„</span>
              <p class="theme-desc">"ê²€ì¦ëœ ì‹¤ë ¥" Â· PLATINUM ë“±ê¸‰ì…ë‹ˆë‹¤.</p>
              <button type="button" class="theme-apply-btn">ì ìš©í•˜ê¸°</button>
            </div>
          </div>
          <div class="profile-theme-card" data-theme="default" data-level-required="141">
            <div class="theme-preview theme-default-tier">
              <div class="tier-crown">ğŸ‘‘</div>
              <div class="theme-preview-avatar legendary"></div>
              <div class="theme-preview-bar legendary"></div>
              <div class="theme-lock-overlay" style="display:none"><img src="{{ url_for('static', filename='images/lock.png') }}" alt="ì ê¸ˆ" class="theme-lock-img"><span class="theme-lock-msg">ë ˆë²¨ ì¡°ê±´ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span></div>
            </div>
            <div class="theme-info">
              <span class="theme-level">Lv.141 LEGEND</span>
              <span class="theme-name">ìµœê³ ì„±ê³¼ í”„ë¡œí•„</span>
              <p class="theme-desc">"ì˜í–¥ë ¥ ìˆëŠ” ì„±ì·¨ì" Â· Lv.141ë¶€í„° LEGEND ë“±ê¸‰ ì „ìš©ì…ë‹ˆë‹¤.</p>
              <button type="button" class="theme-apply-btn active">ì‚¬ìš© ì¤‘</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include 'partials/_sidebar_users.html' %}
  {% include 'partials/_toast.html' %}

  <script>
    function openModal(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('active');
        document.body.style.overflow = 'hidden';
        if (id === 'modalProfileTheme') syncThemeButtons();
        if (id === 'modalHashtags' && typeof updateHashtagCount === 'function') updateHashtagCount();
      }
    }
    function closeModal(id) {
      const el = document.getElementById(id);
      if (el) { el.classList.remove('active'); document.body.style.overflow = ''; }
    }
    document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closeModal(overlay.id);
      });
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(function(m) { closeModal(m.id); });
    });

    // í”„ë¡œí•„ í…Œë§ˆ ì ìš© (localStorage) - ì ìš©í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ì ìš©
    const PROFILE_THEME_KEY = 'allyoung_profile_theme';
    const profileSection = document.getElementById('profileSection');
    function applyProfileTheme(theme) {
      if (!profileSection) return;
      // ëª¨ë“  í…Œë§ˆ í´ë˜ìŠ¤ ì œê±° (ë ˆì „ë“œâ†’ë‹¤ë¥¸ í…Œë§ˆ ì „í™˜ ì‹œì—ë„ ì •ìƒ ë™ì‘)
      ['basic','rare','epic','platinum','legend','default'].forEach(function(t) {
        profileSection.classList.remove('profile-theme-' + t);
      });
      if (theme && theme !== 'default') {
        profileSection.classList.add('profile-theme-' + theme);
      }
      try { localStorage.setItem(PROFILE_THEME_KEY, theme || 'default'); } catch (e) {}
      syncThemeButtons();
    }
    function syncThemeButtons() {
      try {
        const current = localStorage.getItem(PROFILE_THEME_KEY) || 'default';
        const grid = document.querySelector('.profile-theme-grid');
        const userLevel = parseInt(grid?.dataset.userLevel || '1', 10);
        document.querySelectorAll('.profile-theme-card').forEach(function(card) {
          const btn = card.querySelector('.theme-apply-btn');
          const overlay = card.querySelector('.theme-lock-overlay');
          const required = parseInt(card.dataset.levelRequired || '1', 10);
          const locked = userLevel < required;
          if (overlay) overlay.style.display = locked ? 'flex' : 'none';
          card.classList.toggle('theme-locked', locked);
          if (btn) {
            btn.disabled = locked;
            if (locked) {
              btn.textContent = 'Lv.' + required + ' í•„ìš”';
              btn.classList.remove('active');
            } else {
              const isActive = (card.dataset.theme || 'default') === current;
              btn.classList.toggle('active', isActive);
              btn.textContent = isActive ? 'ì‚¬ìš© ì¤‘' : 'ì ìš©í•˜ê¸°';
            }
          }
        });
      } catch (e) {}
    }
    (function initProfileTheme() {
      if (!profileSection || profileSection.dataset.ownProfile !== '1') return;
      try {
        const grid = document.querySelector('.profile-theme-grid');
        const userLevel = parseInt(grid?.dataset.userLevel || '1', 10);
        let saved = localStorage.getItem(PROFILE_THEME_KEY);
        if (saved === '') saved = null;
        if (saved === 'legend') {
          if (userLevel >= 141) saved = 'default';
          else if (userLevel >= 121) saved = 'platinum';
          else saved = null;
        }
        const levelMap = { basic: 1, rare: 21, epic: 71, platinum: 121, default: 141 };
        const required = levelMap[saved] ?? 141;
        const canUseSaved = saved && (saved === 'default' || userLevel >= required);
        if (canUseSaved) {
          applyProfileTheme(saved);
        } else {
          if (saved && userLevel < required) {
            try { localStorage.removeItem(PROFILE_THEME_KEY); } catch (e) {}
          }
          applyProfileTheme('default');
          syncThemeButtons();
        }
      } catch (e) {}
    })();
    document.querySelectorAll('.profile-theme-card').forEach(function(card) {
      const btn = card.querySelector('.theme-apply-btn');
      const theme = card.dataset.theme;
      if (btn && theme) {
        btn.addEventListener('click', function() {
          if (btn.disabled || card.classList.contains('theme-locked')) return;
          if (btn.classList.contains('active')) return;
          applyProfileTheme(theme);
          closeModal('modalProfileTheme');
          var t = document.getElementById('toast'); if (t) { t.textContent = 'í”„ë¡œí•„ í…Œë§ˆê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.'; t.className = 'toast success'; t.style.display = 'block'; setTimeout(function() { t.style.display = 'none'; }, 2000); }
        });
      }
    });

    const avatarInput = document.getElementById('avatarInput');
    if (avatarInput) {
    avatarInput.addEventListener('change', async function(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      try {
        const r = await fetch('/api/profile/update-image', { method: 'POST', body: formData });
        const j = await r.json();
        if (j.success && j.profile_url) {
          location.reload();
        } else {
          showToast(j.error || 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      } catch (err) {
        showToast('ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
      e.target.value = '';
    });
    }

    // í•´ì‹œíƒœê·¸ ì €ì¥ ë° ê°œìˆ˜ ì œí•œ
    var hashtagMaxLimit = {{ hashtag_max_limit|default(5) }};
    var hashtagForm = document.getElementById('hashtagForm');
    function updateHashtagCount() {
      var checked = hashtagForm ? hashtagForm.querySelectorAll('input[name="hashtag_id"]:checked') : [];
      var cnt = checked.length;
      var countEl = document.getElementById('hashtagCount');
      if (countEl) countEl.textContent = cnt + ' / ' + hashtagMaxLimit;
      var inputs = hashtagForm ? hashtagForm.querySelectorAll('input[name="hashtag_id"]') : [];
      inputs.forEach(function(inp) {
        if (inp.checked) inp.disabled = false;
        else inp.disabled = cnt >= hashtagMaxLimit;
      });
    }
    if (hashtagForm) {
      hashtagForm.querySelectorAll('input[name="hashtag_id"]').forEach(function(inp) {
        inp.addEventListener('change', updateHashtagCount);
      });
      if (document.getElementById('modalHashtags')) {
        document.getElementById('modalHashtags').addEventListener('click', function() {
          setTimeout(updateHashtagCount, 0);
        });
      }
      updateHashtagCount();
    }
    const btnSaveHashtags = document.getElementById('btnSaveHashtags');
    if (btnSaveHashtags) {
      btnSaveHashtags.addEventListener('click', function() {
        const form = document.getElementById('hashtagForm');
        if (!form) return;
        const checked = form.querySelectorAll('input[name="hashtag_id"]:checked');
        const hashtagIds = Array.from(checked).map(function(cb) { return parseInt(cb.value, 10); });
        if (hashtagIds.length > hashtagMaxLimit) {
          showToast('í•´ì‹œíƒœê·¸ëŠ” ìµœëŒ€ ' + hashtagMaxLimit + 'ê°œê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
          return;
        }
        fetch('/api/profile/hashtags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hashtag_ids: hashtagIds })
        }).then(function(r) { return r.json(); }).then(function(j) {
          if (j.success) {
            showToast('í•´ì‹œíƒœê·¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            closeModal('modalHashtags');
            location.reload();
          } else {
            showToast(j.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
        }).catch(function() {
          showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        });
      });
    }

    // ìƒíƒœ ë©”ì‹œì§€ ì €ì¥ (blur ì‹œ)
    const statusInput = document.getElementById('statusInput');
    if (statusInput) {
      let saveTimeout = null;
      function saveStatusMessage(isDelete) {
        const val = (statusInput.value || '').trim();
        fetch('/api/profile/status-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status_message: val })
        }).then(r => r.json()).then(j => {
          if (j.success) showToast(isDelete === true || !val ? 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          else showToast(j.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        });
      }
      statusInput.addEventListener('blur', saveStatusMessage);
      statusInput.addEventListener('input', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveStatusMessage, 800);
      });
      const btnSave = document.getElementById('btnSaveStatus');
      if (btnSave) btnSave.addEventListener('click', function() { saveStatusMessage(false); });
      const btnClear = document.getElementById('btnClearStatus');
      if (btnClear) {
        btnClear.addEventListener('click', function() {
          statusInput.value = '';
          saveStatusMessage(true);
        });
      }
    }

    // ì°¸ê°€/íŒ¨ìŠ¤ ê³µëª¨ì „ ëª©ë¡ ë¡œë“œ (5ê°œì”©, ìµœëŒ€ 10í˜ì´ì§€)
    const participationSection = document.getElementById('participationSection');
    const participationList = document.getElementById('participationList');
    const participationLoading = document.getElementById('participationLoading');
    const participationPagination = document.getElementById('participationPagination');
    const participationPrev = document.getElementById('participationPrev');
    const participationNext = document.getElementById('participationNext');
    const participationPages = document.getElementById('participationPages');
    const isOwnProfile = participationSection && participationSection.dataset.ownProfile === '1';
    const PARTICIPATION_PAGE_SIZE = 5;
    const PARTICIPATION_MAX_PAGES = 10;
    let participationAllData = [];
    let participationCurrentPage = 1;
    function renderParticipationList(data, page) {
      if (!participationList) return;
      participationAllData = data || [];
      participationCurrentPage = Math.max(1, Math.min(page || 1, PARTICIPATION_MAX_PAGES));
      const totalItems = Math.min(participationAllData.length, PARTICIPATION_PAGE_SIZE * PARTICIPATION_MAX_PAGES);
      const totalPages = Math.max(1, Math.ceil(totalItems / PARTICIPATION_PAGE_SIZE));
      const start = (participationCurrentPage - 1) * PARTICIPATION_PAGE_SIZE;
      const pageData = participationAllData.slice(start, start + PARTICIPATION_PAGE_SIZE);
      if (participationAllData.length === 0) {
        participationList.innerHTML = '<div style="color:var(--gray-muted);padding:24px;text-align:center;">ì°¸ê°€ ë˜ëŠ” íŒ¨ìŠ¤í•œ ê³µëª¨ì „ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        if (participationPagination) participationPagination.style.display = 'none';
        return;
      }
      participationList.innerHTML = pageData.map(function(item) {
        const badgeClass = item.status === 'participate' ? 'participate' : 'pass';
        const badgeText = item.status === 'participate' ? 'ì°¸ê°€' : 'íŒ¨ìŠ¤';
        const linkUrl = item.url || '#';
        const meta = [item.d_day && item.d_day !== '-' ? item.d_day : '', item.host && item.host !== '-' ? item.host : ''].filter(Boolean).join(' Â· ');
        const src = String(item.source || '').replace(/"/g, '&quot;');
        const cid = String(item.contest_id || '').replace(/"/g, '&quot;');
        const linkPart = '<a href="' + linkUrl + '" target="_blank" rel="noopener" class="participation-item">' +
          '<span class="participation-badge ' + badgeClass + '">' + badgeText + '</span>' +
          '<div class="participation-info">' +
          '<div class="participation-title">' + (item.title || '(ì œëª© ì—†ìŒ)').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' +
          (meta ? '<div class="participation-meta">' + meta.replace(/</g, '&lt;') + '</div>' : '') +
          '</div>' +
          '</a>';
        const delBtn = isOwnProfile ? '<button type="button" class="participation-delete-btn" data-source="' + src + '" data-contest-id="' + cid + '">ì‚­ì œ</button>' : '';
        return '<div class="participation-item-wrap">' + linkPart + delBtn + '</div>';
      }).join('');
      if (participationPagination) {
        participationPagination.style.display = totalPages > 1 ? 'flex' : 'none';
        if (participationPrev) {
          participationPrev.disabled = participationCurrentPage <= 1;
          participationPrev.onclick = function() { if (participationCurrentPage > 1) renderParticipationList(participationAllData, participationCurrentPage - 1); };
        }
        if (participationNext) {
          participationNext.disabled = participationCurrentPage >= totalPages;
          participationNext.onclick = function() { if (participationCurrentPage < totalPages) renderParticipationList(participationAllData, participationCurrentPage + 1); };
        }
        if (participationPages) {
          var maxShow = Math.min(totalPages, PARTICIPATION_MAX_PAGES);
          var html = [];
          for (var i = 1; i <= maxShow; i++) {
            var active = i === participationCurrentPage ? ' active' : '';
            html.push('<button type="button" class="participation-page-btn' + active + '" data-page="' + i + '">' + i + '</button>');
          }
          participationPages.innerHTML = html.join('');
          participationPages.querySelectorAll('.participation-page-btn').forEach(function(btn) {
            btn.addEventListener('click', function() { renderParticipationList(participationAllData, parseInt(btn.dataset.page, 10)); });
          });
        }
      }
      participationList.querySelectorAll('.participation-delete-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const src = btn.dataset.source || '';
          const cid = btn.dataset.contestId || '';
          if (!src || !cid) return;
          if (!confirm('ì´ ê³µëª¨ì „ì„ ì°¸ê°€/íŒ¨ìŠ¤ ëª©ë¡ì—ì„œ ì‚­ì œí• ê¹Œìš”?')) return;
          fetch('/api/contests/' + encodeURIComponent(src) + '/' + encodeURIComponent(cid) + '/participation', { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(j) {
              if (j.success) {
                const idx = participationAllData.findIndex(function(x) { return x.source === src && x.contest_id === cid; });
                if (idx >= 0) participationAllData.splice(idx, 1);
                renderParticipationList(participationAllData, participationCurrentPage);
                var t = document.getElementById('toast'); if (t) { t.textContent = 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'; t.className = 'toast success'; t.style.display = 'block'; setTimeout(function() { t.style.display = 'none'; }, 2000); }
              } else { alert(j.error || 'ì‚­ì œ ì‹¤íŒ¨'); }
            })
            .catch(function() { alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
        });
      });
    }
    if (participationList) {
      (async function() {
        try {
          const profileUserId = participationSection ? (participationSection.dataset.userId || '') : '';
          const url = profileUserId ? '/api/user/participation?user_id=' + encodeURIComponent(profileUserId) : '/api/user/participation';
          const r = await fetch(url);
          const j = await r.json();
          if (participationLoading) participationLoading.remove();
          renderParticipationList(j.data || [], 1);
        } catch (e) {
          if (participationLoading) participationLoading.remove();
          participationList.innerHTML = '<div style="color:#dc2626;padding:24px;text-align:center;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
      })();
    }

    // ìµœê·¼ ë³¸ ê³µëª¨ì „ ë¡œë“œ (ë‚´ í”„ë¡œí•„ì¼ ë•Œë§Œ)
    (async function() {
      const ul = document.getElementById('recentContests');
      if (!ul) return;
      try {
        const raw = localStorage.getItem('allyoung_viewed');
        const ids = raw ? JSON.parse(raw) : [];
        if (ids.length === 0) return;
        const r = await fetch('/api/contests/by-ids?ids=' + ids.slice(-10).reverse().join(','));
        const j = await r.json();
        if (!j.success || !j.data || j.data.length === 0) return;
        ul.innerHTML = j.data.slice(0, 5).map(c =>
          '<li><a href="' + (c.url || '#') + '" target="_blank">' + (c.title || '-') + '</a></li>'
        ).join('');
      } catch (_) {}
    })();
  </script>
  {% include 'partials/_loading_overlay.html' %}
  <script src="{{ url_for('static', filename='js/loading.js') }}"></script>
</body>
</html>
