# 접속 유저 (온라인/오프라인) 설명

## 로그아웃 후 다시 로그인해야 하는 이유

**로그아웃**을 하면 서버에 저장된 **세션(session)** 이 모두 삭제됩니다.
- 세션: 로그인한 사용자 정보(닉네임, 이메일, user_id 등)를 임시 저장하는 저장소
- 로그아웃 시 `session.clear()` 호출 → 모든 로그인 정보 제거
- 따라서 **다시 사용하려면 로그인**해야 합니다 (정상 동작)

---

## 접속 유저 목록은 어떻게 동작하나요?

오른쪽 사이드바에 **접속 유저** 목록이 보입니다.  
각 사용자가 **접속 중**인지 **오프라인**인지는 아래 테이블로 판단합니다.

### 사용하는 테이블: `presence`

| 위치 | **Supabase PostgreSQL** |
|------|---------------------------|
| 테이블명 | `presence` |

| 컬럼 | 타입 | 설명 |
|------|------|------|
| user_id | UUID | Supabase Auth 사용자 ID (auth.users.id) |
| last_seen | TIMESTAMPTZ | 마지막 접속/오프라인 시각 |
| online | BOOLEAN | 접속 중이면 true, 오프라인이면 false |

### 판단 기준

| 상태 | 조건 |
|------|------|
| **접속 중** | `presence` 테이블에 **row가 있는** 사용자 |
| **오프라인** | presence에 기록 없음 |

### 동작 흐름

1. **로그인** 시 → `presence`에 upsert (online=true, last_seen=now)
2. **로그아웃** 시 → `presence` update (online=false, last_seen=now) - 몇 분 전 오프라인 표시용
3. 사이드바는 `/api/users`로 사용자 목록 + 접속 상태를 조회하며, 2분마다 자동 새로고침

### 테이블 생성

Supabase Dashboard → **SQL Editor**에서 `docs/tables.sql`의 presence 섹션을 실행하세요.  
(배포 환경에서도 모든 서버가 동일한 PostgreSQL을 사용하므로 접속 상태가 공유됩니다.)

### .env 설정

presence INSERT/DELETE/SELECT는 **service role**로 RLS를 우회합니다.  
`.env`에 `SUPABASE_SERVICE_ROLE_KEY`를 설정하세요 (Supabase Dashboard → Settings → API → service_role).

---

## 요약

| 질문 | 답변 |
|------|------|
| 로그아웃 후? | 다시 로그인해야 함 (세션 삭제됨) |
| presence 테이블? | Supabase PostgreSQL에 저장, 배포 시 공유 |
| 접속 중 기준? | presence.online=true (몇 분 전 접속/오프라인 시간 표시 가능) |
