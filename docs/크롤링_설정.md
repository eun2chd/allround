# 크롤링 설정 (GitHub Actions + Supabase Edge Function)

30분마다 공모전 데이터를 크롤링해 Supabase `contests` 테이블에 저장합니다.

---

## 크롤링 전략

| 소스 | Edge Function | 스케줄 | 페이지 | 설명 |
|------|----------------|--------|--------|------|
| **요즘것들** | crawl-contests | 30분마다 | 1~3 / 1~10 | allforyoung.com 공고 |
| **위비티** | crawl-wevity | 30분마다 | 1~3 / 빈 페이지까지 | wevity.com 공고 |

- 30분: 새 공고 빠르게 반영
- 위비티: DB 비어있으면 **빈 페이지 나올 때까지** 크롤링 (최대 100페이지)
- Edge Function `?full=1` 또는 body `{"full": true}` 로 수동 전체 크롤링 가능

---

## 1. Edge Function 배포

```bash
# Supabase CLI 로그인 (최초 1회)
npx supabase login


올바른 project-ref 찾는 방법
방법 1 — 대시보드에서 복사 (가장 빠름)

Supabase 접속

프로젝트 선택

Settings → General

Reference ID 복사
# 프로젝트 연결
npx supabase link --project-ref mpebinshiekevzxbdaxb

# 함수 배포
npx supabase functions deploy crawl-contests
npx supabase functions deploy crawl-wevity
```

---

## 2. GitHub Secrets 설정

Repository → Settings → Secrets and variables → Actions 에서 추가:

| Secret 이름 | 설명 | 예시 |
|-------------|------|------|
| `SUPABASE_URL` | Supabase 프로젝트 URL | `https://xxxx.supabase.co` |
| `SUPABASE_SERVICE_ROLE_KEY` | 서비스 롤 키 (Settings → API) | `eyJhbGci...` |

> Service Role Key는 Dashboard → Project Settings → API 에서 확인

---

## 3. 동작

| 워크플로우 | 스케줄 | 내용 |
|------------|--------|------|
| Crawl Contests (30min) | 매 30분 | 요즘것들 + 위비티 증분 |
| Crawl Contests (Full Daily) | 매일 2시 UTC | 요즘것들 전체 |
| Crawl 위비티 (Full Daily) | 매일 3시 UTC | 위비티 전체 (빈 페이지까지) |

- **수동 실행**: Actions → 해당 워크플로우 → Run workflow
- **흐름**: GitHub Actions → Edge Function 호출 → 크롤링 → Supabase upsert

## 4. Realtime 즉시 반영 (선택)

프론트엔드가 `contests` INSERT 시 자동 갱신하려면 **Replication**을 켜야 합니다.

**Supabase 대시보드** → Database → Replication → Tables에서 `contests` ON 확인.

(이미 등록된 경우 `ALTER PUBLICATION supabase_realtime ADD TABLE contests` 실행 시 "already member" 오류가 나오며, 이는 정상입니다.)

---

## 5. 로컬 테스트

```bash
# Edge Function 로컬 실행
npx supabase functions serve crawl-contests --no-verify-jwt

# 호출 (다른 터미널)
curl -X POST http://localhost:54321/functions/v1/crawl-contests \
  -H "Authorization: Bearer <SUPABASE_SERVICE_ROLE_KEY>"
```
